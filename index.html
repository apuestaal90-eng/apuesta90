<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apuesta al 90 ‚Äî Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap');
    :root{--fire1:#ff2200;--fire2:#ff6600;--fire3:#ffaa00;--gold:#ffd700;--card:rgba(12,7,2,0.88);--border:rgba(255,150,0,0.22);}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#080200;color:#fff;font-family:'Rajdhani',sans-serif;min-height:100vh;overflow-x:hidden;}
    #bg{position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse at 50% 115%,#ff4400 0%,#bb1a00 28%,#1a0500 65%,#000 100%);}
    #sparks{position:fixed;inset:0;z-index:1;pointer-events:none;}

    /* ===== MODAL ===== */
    .modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;padding:16px;}
    .modal-overlay.hidden{display:none;}
    .modal-box{background:linear-gradient(160deg,#1c0a00,#0d0300);border:1px solid rgba(255,150,0,.4);border-radius:18px;padding:36px 28px 28px;max-width:440px;width:100%;text-align:center;box-shadow:0 0 80px rgba(255,80,0,.3);position:relative;animation:modalIn .3s ease;}
    @keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(20px)}to{opacity:1;transform:none}}
    .modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--fire2),var(--gold),var(--fire2),transparent);border-radius:18px 18px 0 0;}
    .modal-logo{font-size:48px;margin-bottom:8px;}
    .modal-title{font-family:'Bebas Neue',cursive;font-size:clamp(26px,6vw,38px);letter-spacing:3px;color:var(--gold);margin-bottom:4px;}
    .modal-sub{font-size:13px;color:rgba(255,255,255,.45);margin-bottom:28px;line-height:1.6;}
    .hidden{display:none;}
    .modal-label{font-family:'Bebas Neue',cursive;font-size:13px;letter-spacing:2px;color:rgba(255,200,100,.6);text-align:left;margin-bottom:6px;display:block;}
    .modal-input{width:100%;padding:13px 16px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,150,0,.3);color:#fff;font-family:'Rajdhani',sans-serif;font-size:16px;outline:none;margin-bottom:14px;transition:border-color .2s,box-shadow .2s;}
    .modal-input:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(255,215,0,.1);}
    .modal-input::placeholder{color:rgba(255,255,255,.25);}
    .btn-primary{width:100%;padding:14px;border:none;border-radius:10px;font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:2px;color:#000;cursor:pointer;background:linear-gradient(135deg,var(--fire1),var(--fire2),var(--gold));box-shadow:0 0 24px rgba(255,100,0,.4);transition:transform .2s,box-shadow .2s,opacity .2s;margin-bottom:12px;}
    .btn-primary:hover{transform:scale(1.03);box-shadow:0 0 36px rgba(255,150,0,.6);}
    .btn-primary:disabled{opacity:.45;cursor:not-allowed;transform:none;}
    .modal-msg{font-size:13px;min-height:22px;margin:4px 0 10px;font-weight:700;letter-spacing:1px;}
    .msg-ok{color:#4dff8a;} .msg-err{color:#ff5555;} .msg-loading{color:rgba(255,200,100,.8);}
    .modal-divider{display:flex;align-items:center;gap:10px;margin:16px 0 12px;color:rgba(255,255,255,.2);font-size:12px;letter-spacing:1px;}
    .modal-divider::before,.modal-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.1);}
    .btn-secondary{width:100%;padding:12px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,150,0,.2);color:rgba(255,200,100,.75);font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;cursor:pointer;transition:background .2s,border-color .2s;}
    .btn-secondary:hover{background:rgba(255,100,0,.1);border-color:rgba(255,180,0,.45);}
    .modal-nota{font-size:11px;color:rgba(255,255,255,.2);margin-top:16px;line-height:1.6;}
    .access-ok-icon{font-size:56px;margin-bottom:12px;}
    .access-ok-name{font-family:'Bebas Neue',cursive;font-size:clamp(20px,5vw,28px);color:var(--gold);letter-spacing:2px;margin-bottom:6px;}
    .access-ok-sub{font-size:13px;color:rgba(255,255,255,.45);margin-bottom:24px;}
    .btn-go-quiniela{display:flex;align-items:center;justify-content:center;gap:10px;font-family:'Bebas Neue',cursive;font-size:clamp(18px,4vw,24px);letter-spacing:2px;color:#000;background:linear-gradient(135deg,var(--fire1),var(--fire2),var(--gold));border:none;border-radius:10px;padding:14px 32px;cursor:pointer;box-shadow:0 0 28px rgba(255,100,0,.5);transition:transform .2s,box-shadow .2s;text-decoration:none;width:100%;margin-bottom:12px;}
    .btn-go-quiniela:hover{transform:scale(1.03);box-shadow:0 0 40px rgba(255,150,0,.7);}
    .btn-cerrar{font-size:12px;color:rgba(255,255,255,.3);background:none;border:none;cursor:pointer;letter-spacing:1px;font-family:'Rajdhani',sans-serif;margin-top:4px;text-decoration:underline;}
    .btn-cerrar:hover{color:rgba(255,255,255,.6);}
    .btn-arrow{animation:parrow 1s ease-in-out infinite alternate;}
    @keyframes parrow{from{transform:translateX(0)}to{transform:translateX(6px)}}

    /* ===== HEADER ===== */
    header{position:relative;z-index:10;text-align:center;padding:26px 16px 14px;}
    .jornada-badge{display:inline-block;font-family:'Bebas Neue',cursive;font-size:clamp(13px,2.5vw,17px);letter-spacing:4px;color:var(--gold);background:rgba(255,120,0,0.13);border:1px solid rgba(255,180,0,0.28);border-radius:4px;padding:4px 20px;margin-bottom:14px;}
    .btn-quiniela{display:inline-flex;align-items:center;gap:10px;text-decoration:none;font-family:'Bebas Neue',cursive;font-size:clamp(16px,3.5vw,22px);letter-spacing:2px;color:#000;background:linear-gradient(135deg,var(--fire1) 0%,var(--fire2) 45%,var(--gold) 100%);border:none;border-radius:8px;padding:12px 32px;cursor:pointer;position:relative;overflow:hidden;box-shadow:0 0 24px rgba(255,100,0,0.5);margin-top:8px;transition:transform .2s,box-shadow .2s;}
    .btn-quiniela::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);transform:translateX(-100%);transition:transform .5s;}
    .btn-quiniela:hover{transform:scale(1.04);box-shadow:0 0 36px rgba(255,150,0,.7);}
    .btn-quiniela:hover::after{transform:translateX(100%);}

    /* ===== TABS ===== */
    .tabs-wrap{position:relative;z-index:10;max-width:1200px;margin:22px auto 0;padding:0 12px;}
    .tabs-nav{display:flex;gap:3px;background:rgba(0,0,0,0.55);border:1px solid var(--border);border-bottom:none;border-radius:12px 12px 0 0;padding:6px 6px 0;overflow-x:auto;}
    .tab-btn{font-family:'Bebas Neue',cursive;font-size:clamp(14px,2.8vw,20px);letter-spacing:2px;color:rgba(255,200,100,.5);background:transparent;border:none;border-bottom:3px solid transparent;padding:10px 24px 8px;cursor:pointer;white-space:nowrap;transition:color .2s,border-color .2s,background .2s;}
    .tab-btn:hover{color:var(--gold);}
    .tab-btn.active{color:var(--gold);border-bottom-color:var(--fire2);background:rgba(255,100,0,.13);border-radius:8px 8px 0 0;}
    .tabs-body{position:relative;z-index:10;max-width:1200px;margin:0 auto;padding:0 14px 44px;background:rgba(0,0,0,.48);border:1px solid var(--border);border-top:none;border-radius:0 0 12px 12px;min-height:320px;}
    .tab-panel{display:none;padding-top:22px;}
    .tab-panel.active{display:block;}
    .sec-title{font-family:'Bebas Neue',cursive;font-size:clamp(18px,4vw,26px);letter-spacing:3px;color:var(--gold);border-left:4px solid var(--fire2);padding-left:12px;margin-bottom:18px;}

    /* ===== PARTIDOS ===== */
    .partidos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:14px;}
    .match-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s;}
    .match-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,100,0,.22);}
    .match-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--fire2),transparent);}
    .match-status{font-family:'Bebas Neue',cursive;font-size:11px;letter-spacing:2px;text-align:center;padding:3px 10px;border-radius:20px;margin-bottom:12px;width:fit-content;margin-left:auto;margin-right:auto;}
    .status-live{background:rgba(255,30,30,.2);color:#ff4444;border:1px solid #ff4444;animation:blink 1s infinite;}
    .status-final{background:rgba(100,100,100,.2);color:#aaa;border:1px solid #555;}
    .status-pending{background:rgba(255,180,0,.1);color:var(--gold);border:1px solid rgba(255,180,0,.3);}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
    .teams-row{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .team-side{flex:1;text-align:center;}
    .team-logo{width:52px;height:52px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.6));margin-bottom:6px;}
    .team-name{font-size:11px;font-weight:600;color:rgba(255,255,255,.75);line-height:1.2;}
    .score-box{font-family:'Bebas Neue',cursive;font-size:38px;color:#fff;text-shadow:0 0 20px rgba(255,150,0,.5);letter-spacing:4px;text-align:center;}
    .score-sep{color:rgba(255,150,0,.5);}
    .match-time{text-align:center;font-size:11px;color:rgba(255,255,255,.4);margin-top:8px;}

    /* ===== RANKING ===== */
    .ranking-table{width:100%;border-collapse:collapse;}
    .ranking-table th{font-family:'Bebas Neue',cursive;font-size:13px;letter-spacing:2px;color:rgba(255,180,0,.7);text-align:left;padding:8px 10px;border-bottom:1px solid var(--border);}
    .ranking-table th.center{text-align:center;}
    .ranking-row{border-bottom:1px solid rgba(255,150,0,.08);transition:background .2s;cursor:pointer;}
    .ranking-row:hover{background:rgba(255,100,0,.07);}
    .ranking-row td{padding:10px 10px;vertical-align:middle;}
    .rank-pos{font-family:'Bebas Neue',cursive;font-size:22px;color:rgba(255,200,100,.5);width:36px;text-align:center;}
    .rank-pos.top1{color:#ffd700;} .rank-pos.top2{color:#c0c0c0;} .rank-pos.top3{color:#cd7f32;}
    .rank-name{font-size:16px;font-weight:700;color:#fff;}
    .rank-pts{font-family:'Bebas Neue',cursive;font-size:26px;color:var(--gold);text-align:center;}
    .rank-stats{text-align:center;font-size:12px;color:rgba(255,255,255,.5);}
    .rank-bar-wrap{margin-top:4px;background:rgba(255,255,255,.07);border-radius:4px;height:4px;min-width:60px;}
    .rank-bar{height:4px;border-radius:4px;background:linear-gradient(90deg,var(--fire2),var(--gold));}
    .rank-detail{display:none;padding:0 10px 14px 52px;}
    .rank-detail.open{display:block;}
    .detail-title{font-family:'Bebas Neue',cursive;font-size:13px;letter-spacing:2px;color:rgba(255,180,0,.6);margin-bottom:8px;}
    .detail-matches{display:flex;flex-wrap:wrap;gap:8px;}
    .dm-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,150,0,.12);border-radius:8px;padding:8px 12px;min-width:160px;flex:1;max-width:220px;}
    .dm-teams{font-size:12px;color:rgba(255,255,255,.6);margin-bottom:4px;}
    .dm-pred{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;}
    .dm-result{font-size:11px;color:rgba(255,255,255,.4);}
    .acierto{color:#4dff8a;} .error{color:#ff4d4d;} .pendiente{color:rgba(255,180,0,.6);}
    .badge-acierto{background:rgba(77,255,138,.15);color:#4dff8a;border:1px solid rgba(77,255,138,.3);border-radius:4px;font-size:10px;padding:1px 6px;font-family:'Bebas Neue',cursive;letter-spacing:1px;}
    .badge-error{background:rgba(255,77,77,.15);color:#ff4d4d;border:1px solid rgba(255,77,77,.3);border-radius:4px;font-size:10px;padding:1px 6px;font-family:'Bebas Neue',cursive;letter-spacing:1px;}
    .badge-pend{background:rgba(255,180,0,.1);color:rgba(255,200,100,.7);border:1px solid rgba(255,180,0,.2);border-radius:4px;font-size:10px;padding:1px 6px;font-family:'Bebas Neue',cursive;letter-spacing:1px;}

    /* ===== TABLA ===== */
    .tabla-pos{width:100%;border-collapse:collapse;}
    .tabla-pos th{font-family:'Bebas Neue',cursive;font-size:12px;letter-spacing:2px;color:rgba(255,180,0,.7);padding:8px;border-bottom:1px solid var(--border);text-align:center;}
    .tabla-pos th:first-child{text-align:left;}
    .tabla-pos td{padding:8px;border-bottom:1px solid rgba(255,150,0,.06);text-align:center;font-size:13px;}
    .tabla-pos td:nth-child(2){text-align:left;}
    .tabla-pos tr:hover td{background:rgba(255,100,0,.06);}
    .eq-logo-sm{width:24px;height:24px;object-fit:contain;vertical-align:middle;margin-right:6px;}
    .eq-name{font-size:13px;font-weight:700;vertical-align:middle;}
    .pos-num{font-family:'Bebas Neue',cursive;font-size:16px;color:rgba(255,200,100,.6);}
    .pts-bold{font-family:'Bebas Neue',cursive;font-size:18px;color:var(--gold);}
    .zona-liguilla td:first-child{border-left:3px solid #4dff8a;}
    .zona-repesca td:first-child{border-left:3px solid var(--gold);}
    .zona-descenso td:first-child{border-left:3px solid #ff4d4d;}
    .tabla-leyenda{display:flex;gap:20px;flex-wrap:wrap;margin-top:14px;font-size:12px;}
    .leyenda-item{display:flex;align-items:center;gap:6px;color:rgba(255,255,255,.55);}
    .leyenda-dot{width:10px;height:10px;border-radius:2px;}

    .loading-msg{text-align:center;padding:48px 20px;font-family:'Bebas Neue',cursive;font-size:20px;letter-spacing:3px;color:rgba(255,180,0,.4);}
    .spin{display:inline-block;animation:spin 1s linear infinite;margin-right:8px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .last-update{text-align:right;font-size:11px;color:rgba(255,255,255,.25);padding-top:10px;letter-spacing:1px;}

    @media(max-width:600px){
      .partidos-grid{grid-template-columns:1fr;}
      .dm-card{max-width:100%;}
      .ranking-table th:not(:nth-child(-n+4)){display:none;}
      .modal-box{padding:28px 18px 22px;}
    }
  </style>
</head>
<body>
<div id="bg"></div>
<canvas id="sparks"></canvas>

<!-- ===== MODAL DE ACCESO ===== -->
<div class="modal-overlay" id="modal-acceso">
  <div class="modal-box">

    <!-- PASO 1: verificar email -->
    <div id="paso1">
      <div class="modal-logo">‚öΩ</div>
      <div class="modal-title">Apuesta al 90</div>
      <div class="modal-sub">Ingresa tu email para verificar tu acceso.<br/>Usa el mismo email con el que pagaste.</div>

      <label class="modal-label">Correo electr√≥nico</label>
      <input type="email" id="input-email" class="modal-input" placeholder="tucorreo@gmail.com"
        autocomplete="email" onkeydown="if(event.key==='Enter') verificarAcceso()"/>

      <button class="btn-primary" id="btn-verificar" onclick="verificarAcceso()">
        üîç VERIFICAR ACCESO
      </button>
      <div class="modal-msg" id="modal-msg"></div>

      <div class="modal-divider">¬øA√∫n no has pagado?</div>

      <button class="btn-secondary" onclick="window.open('1lWWAdbC4PQD3NwSLejAl8oHAtkktVnDNJJFZTGgHU8k','_blank')">
        üí≥ PAGAR Y SUBIR COMPROBANTE
      </button>
      <div class="modal-nota">
        Transfiere $50 pesos y sube tu comprobante.<br/>
        Tu acceso se activa autom√°ticamente al instante.<br/>
        Luego regresa aqu√≠ e ingresa tu email.
      </div>
    </div>

    <!-- PASO 2: acceso concedido -->
    <div id="paso2" class="hidden">
      <div class="access-ok-icon">‚úÖ</div>
      <div class="access-ok-name" id="nombre-aprobado">¬°BIENVENIDO!</div>
      <div class="access-ok-sub">Tu pago est√° confirmado.<br/>Ya puedes registrar tu quiniela.</div>
      <a id="btn-go-quiniela" href="https://forms.gle/e1aDvu2CxwoWG7wy7" target="_blank" class="btn-go-quiniela">
        ‚öΩ LLENAR MI QUINIELA <span class="btn-arrow">‚Üí</span>
      </a>
      <button class="btn-cerrar" onclick="cerrarModal()">Solo quiero ver el dashboard ‚Üí</button>
    </div>

  </div>
</div>

<!-- ===== HEADER ===== -->
<header>
  <div class="jornada-badge" id="jornada-label">‚öΩ JORNADA ‚Äî</div><br/>
  <button class="btn-quiniela" onclick="abrirModal()">
    ‚öΩ Registra tu Quiniela <span class="btn-arrow">‚Üí</span>
  </button>
</header>

<!-- ===== TABS ===== -->
<div class="tabs-wrap">
  <nav class="tabs-nav">
    <button class="tab-btn active" onclick="showTab('partidos',this)">‚öΩ Partidos</button>
    <button class="tab-btn" onclick="showTab('ranking',this)">üèÜ Ranking</button>
    <button class="tab-btn" onclick="showTab('tabla',this)">üìä Tabla de Posiciones</button>
  </nav>
</div>
<div class="tabs-body">
  <div class="tab-panel active" id="tab-partidos">
    <div class="sec-title">‚öΩ PARTIDOS ‚Äî JORNADA ACTUAL</div>
    <div class="partidos-grid" id="partidos-container"><div class="loading-msg"><span class="spin">üî•</span> CARGANDO...</div></div>
    <div class="last-update" id="lu-partidos"></div>
  </div>
  <div class="tab-panel" id="tab-ranking">
    <div class="sec-title">üèÜ RANKING DE QUINIELAS</div>
    <div id="ranking-container"><div class="loading-msg"><span class="spin">üî•</span> CARGANDO...</div></div>
    <div class="last-update" id="lu-ranking"></div>
  </div>
  <div class="tab-panel" id="tab-tabla">
    <div class="sec-title">üìä TABLA DE POSICIONES ‚Äî LIGA MX</div>
    <div id="tabla-container"><div class="loading-msg"><span class="spin">üî•</span> CARGANDO...</div></div>
    <div class="last-update" id="lu-tabla"></div>
  </div>
</div>

<script>
const FB_URL    = 'https://apuesta-al-90-15300-default-rtdb.firebaseio.com';
const FB_SECRET = 'p3yH8WCVejRXspNg3oIo6uRDr4A2jH8yRuY9RNMc';

// ===== MODAL =====
function mostrarPaso2(nombre) {
  document.getElementById('nombre-aprobado').textContent = '¬°HOLA, ' + nombre.toUpperCase() + '!';
  document.getElementById('paso1').classList.add('hidden');
  document.getElementById('paso2').classList.remove('hidden');
}

function abrirModal() {
  // Si ya verific√≥ antes (persiste aunque refresque), saltar directo al paso 2
  const savedNombre = localStorage.getItem('a90_nombre');
  if (savedNombre) {
    document.getElementById('modal-acceso').classList.remove('hidden');
    mostrarPaso2(savedNombre);
    return;
  }
  document.getElementById('modal-acceso').classList.remove('hidden');
  document.getElementById('paso1').classList.remove('hidden');
  document.getElementById('paso2').classList.add('hidden');
  document.getElementById('modal-msg').textContent = '';
  document.getElementById('modal-msg').className = 'modal-msg';
  setTimeout(() => document.getElementById('input-email').focus(), 100);
}

function cerrarModal() {
  document.getElementById('modal-acceso').classList.add('hidden');
}

document.getElementById('modal-acceso').addEventListener('click', function(e) {
  if (e.target === this) cerrarModal();
});

async function verificarAcceso() {
  const emailInput = document.getElementById('input-email');
  const btn        = document.getElementById('btn-verificar');
  const msg        = document.getElementById('modal-msg');
  const email      = emailInput.value.trim().toLowerCase();

  if (!email || !email.includes('@')) {
    msg.textContent = '‚ö†Ô∏è Ingresa un email v√°lido';
    msg.className   = 'modal-msg msg-err';
    emailInput.focus();
    return;
  }

  btn.disabled    = true;
  btn.textContent = 'üîç VERIFICANDO...';
  msg.textContent = 'Consultando lista de pagos...';
  msg.className   = 'modal-msg msg-loading';

  try {
    const uid  = email.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    const resp = await fetch(`${FB_URL}/pagados/${uid}.json?auth=${FB_SECRET}`);
    const data = await resp.json();

    if (data && data.pagado === true) {
      // ‚úÖ PAGADO ‚Äî guardar en localStorage para no pedir de nuevo aunque refresque
      const nombre = data.nombre || email.split('@')[0];
      localStorage.setItem('a90_nombre', nombre);
      localStorage.setItem('a90_email', email);
      mostrarPaso2(nombre);
    } else {
      // ‚ùå NO PAGADO
      msg.textContent = '‚ùå Tu email no tiene pago registrado. Sube tu comprobante primero.';
      msg.className   = 'modal-msg msg-err';
      emailInput.select();
    }
  } catch(err) {
    msg.textContent = '‚ö†Ô∏è Error de conexi√≥n. Intenta de nuevo.';
    msg.className   = 'modal-msg msg-err';
  }

  btn.disabled    = false;
  btn.textContent = 'üîç VERIFICAR ACCESO';
}

// ===== TABS =====
function showTab(id, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  btn.classList.add('active');
}

// ===== FIREBASE =====
async function fbGet(path) {
  const r = await fetch(`${FB_URL}/${path}.json?auth=${FB_SECRET}`);
  if (!r.ok) throw new Error('Firebase error: '+r.status);
  return r.json();
}

// ===== HELPERS =====
function tsNow(){return new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function statusClass(e){if(!e)return 'status-pending';const s=e.toLowerCase();if(s==='in'||s.includes('progres')||s.includes('vivo'))return 'status-live';if(s==='post'||s.includes('final'))return 'status-final';return 'status-pending';}
function statusLabel(e){if(!e)return 'üïê PR√ìXIMO';const s=e.toLowerCase();if(s==='in'||s.includes('progres')||s.includes('vivo'))return 'üî¥ EN VIVO';if(s==='post'||s.includes('final'))return '‚úÖ FINAL';return 'üïê PR√ìXIMO';}
function safeLogo(url,alt){return `<img class="team-logo" src="${url||''}" alt="${alt||''}" onerror="this.style.opacity='0.2'">`;}

// ===== RENDER PARTIDOS =====
function renderPartidos(partidos){
  const cont=document.getElementById('partidos-container');
  if(!partidos||!Object.keys(partidos).length){cont.innerHTML='<div class="loading-msg">Sin partidos registrados</div>';return;}
  const order={'in':0,'live':0,'post':2,'final':2,'pre':1};
  const arr=Object.entries(partidos).map(([id,p])=>({id,...p}));
  arr.sort((a,b)=>{const oa=order[(a.estado||'pre').toLowerCase()]??1,ob=order[(b.estado||'pre').toLowerCase()]??1;return oa!==ob?oa-ob:(a.hora||'').localeCompare(b.hora||'');});
  cont.innerHTML=arr.map(p=>{
    const sc=statusClass(p.estado),sl=statusLabel(p.estado);
    const gL=(p.golesL!=null)?p.golesL:(p.goles_local??'‚Äì');
    const gV=(p.golesV!=null)?p.golesV:(p.goles_visita??'‚Äì');
    const isLive=sc==='status-live',isFinal=sc==='status-final';
    return `<div class="match-card">
      <div class="match-status ${sc}">${sl}</div>
      <div class="teams-row">
        <div class="team-side">${safeLogo(p.logoL||p.logo_local,p.local)}<div class="team-name">${p.local||'‚Äî'}</div></div>
        <div><div class="score-box">${(isLive||isFinal)?`${gL} <span class="score-sep">:</span> ${gV}`:`<span style="font-size:22px;opacity:.4">vs</span>`}</div></div>
        <div class="team-side">${safeLogo(p.logoV||p.logo_visita,p.visita)}<div class="team-name">${p.visita||'‚Äî'}</div></div>
      </div>
      <div class="match-time">${p.fecha||''} ${p.hora?'¬∑ '+p.hora:''}</div>
    </div>`;
  }).join('');
  document.getElementById('lu-partidos').textContent='Actualizado: '+tsNow();
}

// ===== RENDER RANKING =====
function renderRanking(rankingData,partidos,quinielas){
  const cont=document.getElementById('ranking-container');
  if(!rankingData||!Object.keys(rankingData).length){cont.innerHTML='<div class="loading-msg">Sin datos de ranking</div>';return;}
  let arr=Object.entries(rankingData).map(([key,r])=>({key,...r}));
  arr.sort((a,b)=>{const pa=a.puntos??0,pb=b.puntos??0;if(pb!==pa)return pb-pa;return (b.aciertos??0)-(a.aciertos??0);});
  const maxPts=Math.max(...arr.map(r=>r.puntos??0),1);
  const medals=['ü•á','ü•à','ü•â'];
  const rr={};
  if(partidos)Object.entries(partidos).forEach(([id,p])=>{
    const gL=p.golesL??p.goles_local,gV=p.golesV??p.goles_visita;
    let res=null;
    if(gL!=null&&gV!=null&&(p.estado==='post'||(p.estado||'').toLowerCase().includes('final')))
      res=Number(gL)>Number(gV)?'L':Number(gV)>Number(gL)?'V':'E';
    rr[id]={local:p.local||p.equipo_local||'?',visita:p.visita||p.equipo_visita||'?',gL,gV,res,estado:p.estado};
  });
  cont.innerHTML=`<table class="ranking-table"><thead><tr>
    <th style="width:44px" class="center">#</th><th>Participante</th>
    <th class="center">Pts</th><th class="center">‚úÖ</th><th class="center">‚ùå</th>
    <th class="center" style="min-width:80px">Progreso</th>
  </tr></thead><tbody id="ranking-tbody"></tbody></table>`;
  let html='';
  arr.forEach((r,i)=>{
    const pos=i+1,pts=r.puntos??0,aciertos=r.aciertos??0,total=r.totalPredicciones??0;
    const errores=total>0?total-aciertos:0,nombre=r.nombre||r.key||'?',pct=Math.round((pts/maxPts)*100);
    const posClass=pos===1?'top1':pos===2?'top2':pos===3?'top3':'',medal=medals[i]||'';
    const uid=r.key,qu=(quinielas&&quinielas[uid])?quinielas[uid]:null;
    const preds=qu?(qu.predicciones||{}):{},hasPreds=Object.keys(preds).length>0;
    let detailHtml='';
    if(hasPreds){
      const predsArr=Object.entries(preds).sort(([idA],[idB])=>(rr[idA]?.res?0:1)-(rr[idB]?.res?0:1));
      const cards=predsArr.map(([mid,pred])=>{
        const real=rr[mid]||{},pv=typeof pred==='object'?(pred.resultado||''):String(pred);
        let badge=`<span class="badge-pend">‚è≥ PEND</span>`,pc='pendiente';
        if(real.res){if(pv===real.res){badge=`<span class="badge-acierto">‚úì ACIERTO</span>`;pc='acierto';}else{badge=`<span class="badge-error">‚úó ERROR</span>`;pc='error';}}
        const pl=pv==='L'?'üè† Local':pv==='V'?'‚úàÔ∏è Visita':pv==='E'?'ü§ù Empate':(pv||'?');
        const rl=real.res?(real.res==='L'?'üè† Local':real.res==='V'?'‚úàÔ∏è Visita':'ü§ù Empate'):'';
        return `<div class="dm-card">
          <div class="dm-teams">${real.local||mid} vs ${real.visita||''}</div>
          <div class="dm-pred ${pc}"><span>${pl}</span>${badge}</div>
          ${real.res?`<div class="dm-result">Real: ${rl} (${real.gL??'?'}-${real.gV??'?'})</div>`:`<div class="dm-result" style="color:rgba(255,180,0,.4)">Pendiente</div>`}
        </div>`;
      }).join('');
      detailHtml=`<tr><td colspan="6" style="padding:0"><div class="rank-detail" id="detail-${i}">
        <div class="detail-title">üìã PREDICCIONES ‚Äî ${nombre}</div>
        <div class="detail-matches">${cards}</div>
      </div></td></tr>`;
    }
    html+=`<tr class="ranking-row" onclick="toggleDetail(${i})" style="cursor:pointer">
      <td><div class="rank-pos ${posClass}">${medal||pos}</div></td>
      <td><div class="rank-name">${nombre}</div>
        <div style="font-size:10px;color:rgba(255,200,100,.4);margin-top:2px;">${hasPreds?'‚ñº ver predicciones':'Sin predicciones'}</div></td>
      <td><div class="rank-pts">${pts}</div></td>
      <td><div class="rank-stats" style="color:#4dff8a;font-size:16px;font-weight:700;">${aciertos}</div></td>
      <td><div class="rank-stats" style="color:#ff4d4d;font-size:16px;font-weight:700;">${errores}</div></td>
      <td><div class="rank-bar-wrap"><div class="rank-bar" style="width:${pct}%"></div></div>
        <div style="font-size:10px;color:rgba(255,255,255,.3);text-align:center;margin-top:2px;">${pct}%</div></td>
    </tr>${detailHtml}`;
  });
  document.getElementById('ranking-tbody').innerHTML=html;
  document.getElementById('lu-ranking').textContent='Actualizado: '+tsNow();
}
function toggleDetail(i){const el=document.getElementById('detail-'+i);if(el)el.classList.toggle('open');}

// ===== RENDER TABLA =====
function renderTabla(tablaData){
  const cont=document.getElementById('tabla-container');
  if(!tablaData||!Object.keys(tablaData).length){cont.innerHTML='<div class="loading-msg">Sin tabla.<br><span style="font-size:14px;opacity:.6">Ejecuta ACTUALIZAR_TABLA_POSICIONES.</span></div>';return;}
  const arr=Object.values(tablaData).sort((a,b)=>{const pa=a.puntos??0,pb=b.puntos??0;if(pb!==pa)return pb-pa;return((b.goles_favor??0)-(b.goles_contra??0))-((a.goles_favor??0)-(a.goles_contra??0));});
  const rows=arr.map((e,i)=>{
    const pos=i+1,zonaClass=pos<=8?'zona-liguilla':pos<=12?'zona-repesca':pos>=arr.length-2?'zona-descenso':'';
    const pts=e.puntos??0,pj=e.pj??0,g=e.g??0,emp=e.e??0,p=e.p??0;
    const gf=e.goles_favor??e.gf??0,gc=e.goles_contra??e.gc??0,dif=gf-gc;
    return `<tr class="${zonaClass}">
      <td><span class="pos-num">${pos}</span></td>
      <td>${e.logo?`<img class="eq-logo-sm" src="${e.logo}" onerror="this.style.display='none'" alt="">`:''}<span class="eq-name">${e.equipo||'‚Äî'}</span></td>
      <td>${pj}</td><td style="color:#4dff8a">${g}</td><td style="color:rgba(255,255,255,.5)">${emp}</td>
      <td style="color:#ff4d4d">${p}</td><td>${gf}</td><td>${gc}</td>
      <td style="color:${dif>0?'#4dff8a':dif<0?'#ff4d4d':'rgba(255,255,255,.5)'}">${dif>0?'+':''}${dif}</td>
      <td><span class="pts-bold">${pts}</span></td>
    </tr>`;
  }).join('');
  cont.innerHTML=`<div style="overflow-x:auto"><table class="tabla-pos">
    <thead><tr><th>#</th><th style="text-align:left">Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th><th>GF</th><th>GC</th><th>DIF</th><th>PTS</th></tr></thead>
    <tbody>${rows}</tbody></table></div>
    <div class="tabla-leyenda">
      <div class="leyenda-item"><div class="leyenda-dot" style="background:#4dff8a"></div>Liguilla (Top 8)</div>
      <div class="leyenda-item"><div class="leyenda-dot" style="background:var(--gold)"></div>Repesca (9-12)</div>
      <div class="leyenda-item"><div class="leyenda-dot" style="background:#ff4d4d"></div>Descenso</div>
    </div>`;
  document.getElementById('lu-tabla').textContent='Actualizado: '+tsNow();
}

// ===== MAIN LOAD =====
let _partidos={},_ranking={},_quinielas={},_tabla={};
async function loadAll(){
  try{
    try{const jNum=await fbGet('jornada_numero');if(jNum)document.getElementById('jornada-label').textContent=`‚öΩ JORNADA ${jNum}`;}catch(e){}
    try{_partidos=await fbGet('jornada_actual')||{};renderPartidos(_partidos);}catch(e){document.getElementById('partidos-container').innerHTML='<div class="loading-msg">Error cargando partidos</div>';}
    try{_quinielas=await fbGet('quinielas')||{};}catch(e){_quinielas={};}
    try{_ranking=await fbGet('ranking')||{};renderRanking(_ranking,_partidos,_quinielas);}catch(e){document.getElementById('ranking-container').innerHTML='<div class="loading-msg">Error cargando ranking</div>';}
    try{_tabla=await fbGet('tabla_posiciones')||{};renderTabla(_tabla);}catch(e){document.getElementById('tabla-container').innerHTML='<div class="loading-msg">Sin tabla a√∫n</div>';}
  }catch(e){console.error('Error:',e);}
}

// ===== SPARKS =====
(function(){
  const canvas=document.getElementById('sparks'),ctx=canvas.getContext('2d');
  let W,H,sparks=[];
  function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
  window.addEventListener('resize',resize);resize();
  function rand(a,b){return a+Math.random()*(b-a);}
  function spawn(){sparks.push({x:rand(0,W),y:H+10,vx:rand(-0.6,0.6),vy:rand(-2.5,-0.8),life:1,decay:rand(0.004,0.012),r:rand(1,3),hue:rand(10,45)});}
  function frame(){
    ctx.clearRect(0,0,W,H);if(Math.random()<0.45)spawn();
    sparks=sparks.filter(s=>s.life>0);
    sparks.forEach(s=>{
      s.x+=s.vx+Math.sin(Date.now()*0.001+s.y)*0.3;s.y+=s.vy;s.vy*=0.998;s.life-=s.decay;
      ctx.save();ctx.globalAlpha=s.life*0.85;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle=`hsl(${s.hue},100%,65%)`;ctx.shadowBlur=8;ctx.shadowColor=`hsl(${s.hue},100%,65%)`;ctx.fill();ctx.restore();
    });requestAnimationFrame(frame);
  }frame();
})();

loadAll();
setInterval(loadAll,60000);
</script>
</body>
</html>
